global
    log stdout format raw local0 info
    maxconn 128
    tune.bufsize 8192
    tune.maxrewrite 1024

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    maxconn 64

# Stick tables (global, outside frontend/backend)
# Table 1: Track admin requests and rate limit (2 req/60s)
backend admin_rate_tracker
    stick-table type ip size 10k expire 60s store http_req_rate(60s)

# Table 2: Track failed admin attempts, block for 1 hour
backend admin_abuse_tracker
    stick-table type ip size 10k expire 1h store gpc0

# Frontend - public interface
frontend http_front
    bind *:8080
    
    # Define ACLs for path matching
    acl is_health path_beg /health
    acl is_onboarding path_beg /onboarding
    acl is_pin_setup path_beg /pin-setup
    acl is_admin path_beg /admin
    acl is_sms_receive path_beg /sms/receive
    
    # Define ACL for local/LAN IPs (localhost, Docker networks, private LANs)
    acl from_local src 127.0.0.0/8 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12
    
    # ===============================================
    # ADMIN ENDPOINT PROTECTION
    # ===============================================
    
    # Track requests to admin endpoints
    http-request track-sc0 src table admin_rate_tracker if is_admin
    http-request track-sc1 src table admin_abuse_tracker if is_admin
    
    # Check if IP is blocked due to failed attempts (gpc0 >= 2 = blocked for 1 hour)
    acl admin_blocked sc1_get_gpc0(admin_abuse_tracker) ge 2
    http-request deny deny_status 403 if is_admin admin_blocked
    
    # Rate limit: max 2 requests per 60 seconds
    acl admin_rate_exceeded sc0_http_req_rate(admin_rate_tracker) gt 2
    http-request deny deny_status 429 if is_admin admin_rate_exceeded
    
    # ===============================================
    # SECURITY RULES
    # ===============================================
    
    # Block /sms/receive from external IPs (403 Forbidden)
    http-request deny deny_status 403 if is_sms_receive !from_local
    
    # Route public endpoints
    use_backend sms_bridge if is_health
    use_backend sms_bridge if is_onboarding
    use_backend sms_bridge if is_pin_setup
    use_backend sms_bridge if is_admin
    use_backend sms_bridge if is_sms_receive from_local
    
    # Block all undefined paths (404 Not Found)
    default_backend deny_backend

# Backend - SMS Bridge service
backend sms_bridge
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server sms1 sms_receiver:8080 check inter 10s fall 3 rise 2
    
    # Track failed admin login attempts (increment gpc0 counter on 401 responses)
    # Note: We can't check path in response rules, tracking is done via sc1 in frontend
    acl login_failed status 401
    http-response sc-inc-gpc0(1) if login_failed

# Deny backend for blocked requests
backend deny_backend
    http-request deny deny_status 404
