global
    log stdout format raw local0 info
    maxconn 128
    tune.bufsize 8192
    tune.maxrewrite 1024

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    maxconn 64

# Frontend - public interface
frontend http_front
    bind *:8080
    
    # Define ACLs for path matching
    acl is_health path_beg /health
    acl is_onboarding path_beg /onboarding
    acl is_pin_setup path_beg /pin-setup
    acl is_admin path_beg /admin
    acl is_sms_receive path_beg /sms/receive
    
    # Define ACL for local/LAN IPs (localhost, Docker networks, private LANs)
    acl from_local src 127.0.0.0/8 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12
    
    # Block /sms/receive from external IPs (403 Forbidden)
    http-request deny deny_status 403 if is_sms_receive !from_local
    
    # Route public endpoints
    use_backend sms_bridge if is_health
    use_backend sms_bridge if is_onboarding
    use_backend sms_bridge if is_pin_setup
    use_backend sms_bridge if is_admin
    use_backend sms_bridge if is_sms_receive from_local
    
    # Block all undefined paths (404 Not Found)
    default_backend deny_backend

# Backend - SMS Bridge service
backend sms_bridge
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server sms1 sms_receiver:8000 check inter 10s fall 3 rise 2

# Deny backend for blocked requests
backend deny_backend
    http-request deny deny_status 404
