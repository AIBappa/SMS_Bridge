# Redis: Real-time checks and Grafana visualization

This document contains a compact set of commands you can run locally to inspect Redis state in real time (keys, counts, and values) and step-by-step instructions to view Redis metrics in Grafana (Prometheus as data source).

Notes:
- The k3s deployment runs Redis in namespace `sms-bridge` and a `redis_exporter` is configured and scraped by Prometheus.
- The playbook configures Grafana and Prometheus for you. Grafana is exposed via a NodePort — check `ansible-k3s` output or `kubectl get services -n sms-bridge` for the exact NodePort (example below uses `30001`).

## Quick prerequisites

- k3s kubectl access (or kubectl pointing to the k3s cluster):
  - Example: `k3s kubectl ...` (used throughout)
- The Redis password is stored in the `sms-bridge-secrets` secret in namespace `sms-bridge`.

## Helpful variables (copy these into your shell)

```bash
# redis pod name (adjust if your pod name differs)
REDIS_POD=$(k3s kubectl get pods -n sms-bridge -o name | grep redis | head -n1 | cut -d/ -f2)

# retrieve redis password from k8s secret
REDIS_PASSWORD=$(k3s kubectl get secret sms-bridge-secrets -n sms-bridge -o jsonpath='{.data.redis-password}' | base64 -d)

echo "Using pod: $REDIS_POD"
echo "Redis password loaded into REDIS_PASSWORD"
```

If you prefer to avoid shell variables, replace `$REDIS_POD` and `$REDIS_PASSWORD` with the literal pod name and password printed by the commands above.

## Real-time Redis CLI commands

Run these from your workstation shell. They exec into the Redis pod and run `redis-cli` authenticated with the password from the secret.

- Get a single key (example: onboarding hash for +919999999999 stored as `onboard_hash:9999999999`):

```bash
k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" GET "onboard_hash:9999999999"
```

- List validated (onboarded) numbers:

```bash
k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" SMEMBERS out_sms_numbers
```

- Get the length of the monitor queue (queued events waiting to be flushed to Postgres):

```bash
k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" LLEN sms_monitor_queue
```

- List any abuse counters (useful after an abuse simulation):

```bash
k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" KEYS "abuse_counter:*"
```

- Show one abuse counter value:

```bash
k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" GET "abuse_counter:9999512345"
```

- Quickly scan keys (safer than KEYS in production):

```bash
k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" SCAN 0 MATCH "onboard_hash:*" COUNT 100
```

- Redis INFO (gives metrics: connected clients, memory, evicted keys, uptime) — useful for quick health checks:

```bash
k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" INFO
```

- Monitor incoming commands live (verbose; useful for debugging, stops when you Ctrl+C):

```bash
# This prints every command processed by Redis; use sparingly
k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" MONITOR
```

## Lightweight real-time watching

Use `watch` to poll a Redis value periodically (example: monitor queue length every second):

```bash
watch -n 1 k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" LLEN sms_monitor_queue
```

Or use a short shell loop to poll multiple values at once:

```bash
while true; do
  echo "---- $(date) ----"
  k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" INFO | egrep 'used_memory|connected_clients|expired_keys|evicted_keys'
  k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" LLEN sms_monitor_queue
  sleep 1
done
```

Press Ctrl+C to stop the loop.

## Finding keys generated by your app

- Your app stores keys using predictable prefixes (see migration guide):
  - `onboard_hash:{mobile}`
  - `out_sms_numbers` (SET)
  - `blacklist_mobiles` (SET)
  - `abuse_counter:{mobile}`
  - `sms_monitor_queue` (LIST)

To list recent keys with a prefix, use the `SCAN` example above; avoid `KEYS` on a large database.

## Viewing Redis metrics in Grafana (via Prometheus)

Why this works: the `redis_exporter` exposes Redis metrics in Prometheus format. Prometheus is configured in the playbook to scrape the exporter, and Grafana is pre-configured to use Prometheus as a data source.

High level steps (what you'll do):

1. Open Grafana in your browser.
   - NodePort example: `http://localhost:30001` (use the NodePort printed by your playbook/run)
   - Login with `admin` and the `grafana_admin_password` from your vault (or use the credentials printed by the playbook).

2. Use Explore to discover Redis metrics:
   - In Grafana, click Explore (left menu) and select the Prometheus data source.
   - Start typing `redis` in the query box — Grafana's autocomplete will list available metric names scraped by Prometheus from the `redis_exporter`.

3. Helpful PromQL metrics to visualize (examples — metric names depend on the exporter version; autocomplete in Explore will confirm the exact names):

   - Redis used memory (bytes)
     - Example PromQL: `redis_used_memory_bytes` or start typing `redis_` and pick the appropriate metric

   - Connected clients
     - Example PromQL: `redis_connected_clients`

   - Total commands processed (rate)
     - Example PromQL: `rate(redis_total_commands_processed[1m])`

   - Keyspace hits / misses (cache hit ratio)
     - Example PromQL: `rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))`

   - Evicted / expired keys (errors / reclaims)
     - Example PromQL: `rate(redis_evicted_keys_total[5m])`

If the exact metric names differ, use the Explore autocomplete or visit Prometheus at `http://localhost:30090` and search for metrics starting with `redis`.

### Import a pre-built Redis dashboard

1. In Grafana, go to + (Create) → Import.
2. You can either paste a dashboard JSON (if you have one) or import from Grafana.com by ID. Search Grafana.com for "Redis" or "redis_exporter" dashboards and import one you like.
3. When prompted for a data source, choose the Prometheus data source already configured by the playbook.

The playbook often ships a Postgres dashboard automatically; if you want a Redis-specific dashboard, import one from Grafana.com (search "redis exporter").

### Create a small custom dashboard (quick steps)

1. Dashboard → New Panel.
2. In the query box choose Prometheus and type one of the example PromQL queries above (autocomplete will help).
3. Choose visualization (Graph / Stat / Gauge) and save the dashboard.

## Troubleshooting / verification

- If you do not see Redis metrics in Grafana:
  1. Confirm `redis_exporter` is running: `k3s kubectl get pods -n sms-bridge | grep redis-exporter`.
  2. Check Prometheus is scraping the exporter: open Prometheus at `http://localhost:30090` → Status → Targets, look for the redis exporter target (should be UP).
  3. If the target is down, verify the exporter pod logs: `k3s kubectl logs -n sms-bridge deployment/redis-exporter`.

- If `sms_monitor_queue` stays at 0 and you expect items, check the SMS receiver logs to confirm events are being pushed:
  - `k3s kubectl logs -n sms-bridge deployment/sms-receiver -f`

## Small examples you can copy & run now

```bash
# set variables
REDIS_POD=$(k3s kubectl get pods -n sms-bridge -o name | grep redis | head -n1 | cut -d/ -f2)
REDIS_PASSWORD=$(k3s kubectl get secret sms-bridge-secrets -n sms-bridge -o jsonpath='{.data.redis-password}' | base64 -d)

# watch monitor queue length
watch -n 1 k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" LLEN sms_monitor_queue

# one-shot: show onboarding hash for test number
k3s kubectl exec -n sms-bridge -it "$REDIS_POD" -- redis-cli -a "$REDIS_PASSWORD" GET "onboard_hash:9999999999"

# open Grafana in your browser (example)
echo "Open: http://localhost:30001 (login admin + grafana_admin_password from your vault)"
```

---

If you'd like, I can also:
- Import a recommended Redis dashboard automatically into your running Grafana instance (I can fetch a community dashboard JSON and use Grafana's API to import it), or
- Create a small pre-built dashboard JSON here and add it to the repository so you can import it from the UI.

Tell me which of those you'd prefer and I will proceed.
